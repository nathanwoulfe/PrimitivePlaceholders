"use strict";angular.module("umbraco").controller("primitivePlaceholderController",["$scope","editorState","primitiveHelperService","primitiveCanvasFactory","primitiveTriangleFactory","primitiveRectangleFactory","primitiveEllipseFactory","primitiveOptimizerFactory",function(a,o,t,c,h,e,i,s){var u=document.querySelector("#vector");this.regenerate=r,this.fullscreen=function(t){t.preventDefault(),window.open().document.write('<html><head></head><body><div style="height:100vh">'+a.model.value+"</div></body></html>")};var l={triangle:h,rectangle:e,ellipse:i};function r(t){t&&t.preventDefault();var e,i=o.getCurrent().properties.filter(function(t){return t.alias.toLowerCase()===a.model.config.source.toLowerCase()})[0];if(i){var r="imagecropper"===i.view?i.value.src:i.value,n=(e={steps:+a.model.config.steps||50,alpha:+a.model.config.alpha||.5,computeSize:+a.model.config.computeSize||150,viewSize:700,shapes:+a.model.config.shapes||75,mutations:+a.model.config.mutations||20,mutateAlpha:a.model.config.mutateAlpha||!0,shapeTypes:[h],fill:"auto"},a.model.config.shapeTypes&&(e.shapeTypes=[],a.model.config.shapeTypes.forEach(function(t){e.shapeTypes.push(l[t.value])})),e);c.original(r,n).then(function(t){return i=new s(t,e=n),r=c.empty(e,!0),u.innerHTML="",u.appendChild(r),i.onStep=function(t){t&&r.appendChild(t.toSVG())},i.onComplete=function(){a.$apply(function(){var t=new XMLSerializer;a.model.value=t.serializeToString(r)})},void i.start();var e,i,r})}}a.model.value.length?u.innerHTML=a.model.value:r()}]),angular.module("umbraco.resources").factory("primitiveHelperService",function(){var r="http://www.w3.org/2000/svg";function w(t){return Math.max(0,Math.min(255,t))}function a(t,e,i){var r=[0,0,0],n=e.shape,a=e.current,o=e.target,c=n.data,h=a.data,s=o.data,u=void 0,l=void 0,p=void 0,d=void 0,f=void 0,m=n.width,v=n.height,g=a.width,y=a.height,b=0;for(l=0;l<v;l++)if(!((f=l+t.top)<0||y<=f))for(u=0;u<m;u++)(d=t.left+u)<0||g<=d||0!==c[4*(u+l*m)+3]&&(p=4*(d+f*g),r[0]+=(s[p]-h[p])/i+h[p],r[1]+=(s[p+1]-h[p+1])/i+h[p+1],r[2]+=(s[p+2]-h[p+2])/i+h[p+2],b++);return r.map(function(t){return~~(t/b)}).map(w)}return{distanceToDifference:function(t,e){return Math.pow(255*t,2)*(3*e)},differenceToDistance:function(t,e){return Math.sqrt(t/(3*e))/255},computeColor:a,computeColorAndDifferenceChange:function(t,e,i){var r=a(t,e,i),n=function(t,e,i){var r=e.shape,n=e.current,a=e.target,o=r.data,c=n.data,h=a.data,s=void 0,u=void 0,l=void 0,p=void 0,d=void 0,f=void 0,m=void 0,v=void 0,g=void 0,y=void 0,b=void 0,w=void 0,S=void 0,x=r.width,M=r.height,A=n.width,F=n.height,C=0;for(y=0;y<M;y++)if(!((S=y+t.top)<0||F<=S))for(g=0;g<x;g++)(w=t.left+g)<0||A<=w||0!==(s=o[4*(g+y*x)+3])&&(u=1-(s/=255),C-=(l=h[b=4*(w+S*A)]-c[b])*l+(p=h[b+1]-c[b+1])*p+(d=h[b+2]-c[b+2])*d,C+=(f=h[b]-(i[0]*s+c[b]*u))*f+(v=h[b+1]-(i[1]*s+c[b+1]*u))*v+(m=h[b+2]-(i[2]*s+c[b+2]*u))*m);return C}(t,e,r);return{color:"rgb("+r[0]+", "+r[1]+", "+r[2]+")",differenceChange:n}},getScale:function(t,e,i){return Math.max(t/i,e/i,1)},getFill:function(t){for(var e=t.getImageData(),i=e.width,r=e.height,n=e.data,a=[0,0,0],o=0,c=void 0,h=0;h<i;h++)for(var s=0;s<r;s++)0<h&&0<s&&h<i-1&&s<r-1||(o++,c=4*(h+s*i),a[0]+=n[c],a[1]+=n[c+1],a[2]+=n[c+2]);return"rgb("+(a=a.map(function(t){return~~(t/o)}).map(w))[0]+", "+a[1]+", "+a[2]+")"},svgRect:function(t,e){var i=document.createElementNS(r,"rect");return i.setAttribute("x",0),i.setAttribute("y",0),i.setAttribute("width",t),i.setAttribute("height",e),i}}}),angular.module("umbraco.resources").factory("primitiveCanvasFactory",["primitiveHelperService",function(s){var o="http://www.w3.org/2000/svg";function e(t,e){this.node=document.createElement("canvas"),this.node.width=t,this.node.height=e,this.ctx=this.node.getContext("2d"),this._imageData=null}return e.prototype={clone:function(){var t=new e(this.node.width,this.node.height);return t.ctx.drawImage(this.node,0,0),t},fill:function(t){return this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.node.width,this.node.height),this},getImageData:function(){return this._imageData||(this._imageData=this.ctx.getImageData(0,0,this.node.width,this.node.height)),this._imageData},difference:function(t){for(var e=this.getImageData(),i=t.getImageData(),r=0,n=void 0,a=0;a<e.data.length;a++)a%4!=3&&(r+=(n=i.data[a]-e.data[a])*n);return r},distance:function(t){var e=this.difference(t);return s.differenceToDistance(e,this.node.width*this.node.height)},drawStep:function(t){return this.ctx.globalAlpha=t.alpha,this.ctx.fillStyle=t.color,t.shape.render(this.ctx),this}},e.empty=function(t,e){if(e){var i=document.createElementNS(o,"svg");i.setAttribute("viewBox","0 0 "+t.width+" "+t.height),i.setAttribute("clip-path","url(#clip)");var r=document.createElementNS(o,"defs");i.appendChild(r);var n=document.createElementNS(o,"clipPath");r.appendChild(n),n.setAttribute("id","clip"),n.setAttribute("clipPathUnits","objectBoundingBox");var a=s.svgRect(t.width,t.height);return n.appendChild(a),(a=s.svgRect(t.width,t.height)).setAttribute("fill",t.fill),i.appendChild(a),i}return new this(t.width,t.height).fill(t.fill)},e.original=function(t,c){var h=this;return new Promise(function(a){var o=new Image;o.src=t,o.onload=function(){var t=o.naturalWidth,e=o.naturalHeight,i=s.getScale(t,e,c.computeSize);c.width=t/i,c.height=e/i;var r=s.getScale(t,e,c.viewSize);c.scale=i/r;var n=h.empty(c);n.ctx.drawImage(o,0,0,c.width,c.height),c.fill=s.getFill(n),a(n)}})},e}]),angular.module("umbraco.resources").factory("primitiveOptimizerFactory",["primitiveShapeFactory","primitiveStepFactory","primitiveStateFactory","primitiveCanvasFactory",function(o,c,i,r){function t(t,e){this.cfg=e,this.state=new i(t,r.empty(e)),this._steps=0,this.onStep=function(){},this.onComplete=function(){}}return t.prototype={start:function(){this._ts=Date.now(),this._addShape()},_addShape:function(){var e=this;this._findBestStep().then(function(t){return e._optimizeStep(t)}).then(function(t){e._steps++,t.distance<e.state.distance?(e.state=t.apply(e.state),e.onStep(t)):e.onStep(null),e._continue()})},_continue:function(){var t=this;this._steps<this.cfg.steps?setTimeout(function(){return t._addShape()},10):this.onComplete(null)},_findBestStep:function(){for(var t=this.cfg.shapes,e=null,i=[],r=0;r<t;r++){var n=o.create(this.cfg),a=new c(n,this.cfg).compute(this.state).then(function(t){(!e||t.distance<e.distance)&&(e=t)});i.push(a)}return Promise.all(i).then(function(){return e})},_optimizeStep:function(t){var i=this,r=this.cfg.mutations,n=0,a=null,o=t,e=new Promise(function(t){return a=t});return function e(){if(r<=n)return a(o);o.mutate().compute(i.state).then(function(t){t.distance<o.distance?(n=0,o=t):n++,e()})}(),e}},t}]),angular.module("umbraco.resources").factory("primitiveStateFactory",[function(){return function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1/0;this.target=t,this.canvas=e,this.distance=i===1/0?t.distance(e):i}}]),angular.module("umbraco.resources").factory("primitiveStepFactory",["primitiveHelperService","primitiveStateFactory",function(h,i){function r(t,e){this.shape=t,this.cfg=e,this.alpha=e.alpha,this.color="#000",this.distance=1/0}return r.prototype={toSVG:function(){var t=this.shape.toSVG();return t.setAttribute("fill",this.color),t.setAttribute("fill-opacity",this.alpha?this.alpha.toFixed(2):.5),t},apply:function(t){var e=t.canvas.clone().drawStep(this);return new i(t.target,e,this.distance)},compute:function(t){var e=t.canvas.node.width*t.canvas.node.height,i=this.shape.bbox,r={shape:this.shape.rasterize(this.alpha).getImageData(),current:t.canvas.getImageData(),target:t.target.getImageData()},n=h.computeColorAndDifferenceChange(i,r,this.alpha),a=n.color,o=n.differenceChange;this.color=a;var c=h.distanceToDifference(t.distance,e);return this.distance=h.differenceToDistance(c+o,e),Promise.resolve(this)},mutate:function(){var t=new r(this.shape.mutate(this.cfg),this.cfg);if(this.cfg.mutateAlpha){var e=this.alpha+.08*(Math.random()-.5);t.alpha=Math.max(.1,Math.min(1,e))}return t}},r}]),angular.module("umbraco.resources").factory("primitiveEllipseFactory",["primitiveShapeFactory",function(i){function r(t,e){i.call(this),this.center=i.randomPoint(t,e),this.rx=1+~~(20*Math.random()),this.ry=1+~~(20*Math.random()),this.computeBbox()}return r.prototype=Object.create(i.prototype),angular.extend(r.prototype,{render:function(t){t.beginPath(),t.ellipse(this.center[0],this.center[1],this.rx,this.ry,0,0,2*Math.PI,!1),t.fill()},toSVG:function(){var t=document.createElementNS(svgns,"ellipse");return t.setAttribute("cx",this.center[0]),t.setAttribute("cy",this.center[1]),t.setAttribute("rx",this.rx),t.setAttribute("ry",this.ry),t},mutate:function(){var t=new r(0,0);switch(t.center=this.center.slice(),t.rx=this.rx,t.ry=this.ry,Math.floor(3*Math.random())){case 0:var e=2*Math.random()*Math.PI,i=20*Math.random();t.center[0]+=~~(i*Math.cos(e)),t.center[1]+=~~(i*Math.sin(e));break;case 1:t.rx+=20*(Math.random()-.5),t.rx=Math.max(1,~~t.rx);break;case 2:t.ry+=20*(Math.random()-.5),t.ry=Math.max(1,~~t.ry)}return t.computeBbox()},computeBbox:function(){return this.bbox={left:this.center[0]-this.rx,top:this.center[1]-this.ry,width:2*this.rx,height:2*this.ry},this}}),r}]);var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var i=[],r=!0,n=!1,a=void 0;try{for(var o,c=t[Symbol.iterator]();!(r=(o=c.next()).done)&&(i.push(o.value),!e||i.length!==e);r=!0);}catch(t){n=!0,a=t}finally{try{!r&&c.return&&c.return()}finally{if(n)throw a}}return i}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};angular.module("umbraco.resources").factory("primitivePolygonFactory",["primitiveShapeFactory",function(h){var i="http://www.w3.org/2000/svg";function a(t,e,i){h.call(this),this.points=this._createPoints(t,e,i),this.computeBbox()}return a.prototype=Object.create(h.prototype),angular.extend(a.prototype,{render:function(a){a.beginPath(),this.points.forEach(function(t,e){var i=_slicedToArray(t,2),r=i[0],n=i[1];e?a.lineTo(r,n):a.moveTo(r,n)}),a.closePath(),a.fill()},toSVG:function(){var t=document.createElementNS(i,"path"),e=this.points.map(function(t,e){return(e?"L":"M")+t.join(",")}).join("");return t.setAttribute("d",e+"Z"),t},mutate:function(){var t=new a(0,0);t.points=this.points.map(function(t){return t.slice()});var e=Math.floor(Math.random()*this.points.length),i=t.points[e],r=2*Math.random()*Math.PI,n=20*Math.random();return i[0]+=~~(n*Math.cos(r)),i[1]+=~~(n*Math.sin(r)),t.computeBbox()},computeBbox:function(){var t=[this.points.reduce(function(t,e){return Math.min(t,e[0])},1/0),this.points.reduce(function(t,e){return Math.min(t,e[1])},1/0)],e=t[0],i=t[1],r=[this.points.reduce(function(t,e){return Math.max(t,e[0])},-1/0),this.points.reduce(function(t,e){return Math.max(t,e[1])},-1/0)],n=r[0],a=r[1];return this.bbox={left:e,top:i,width:n-e||1,height:a-i||1},this},_createPoints:function(t,e,i){for(var r=h.randomPoint(t,e),n=[r],a=1;a<i;a++){var o=2*Math.random()*Math.PI,c=20*Math.random();n.push([r[0]+~~(c*Math.cos(o)),r[1]+~~(c*Math.sin(o))])}return n}}),a}]),angular.module("umbraco.resources").factory("primitiveRectangleFactory",["primitivePolygonFactory",function(i){function r(t,e){i.call(this,t,e,4)}return r.prototype=Object.create(i.prototype),angular.extend(r.prototype,{mutate:function(){var t=new r(0,0);t.points=this.points.map(function(t){return t.slice()});var e=~~(20*(Math.random()-.5));switch(Math.floor(4*Math.random())){case 0:t.points[0][0]+=e,t.points[3][0]+=e;break;case 1:t.points[0][1]+=e,t.points[1][1]+=e;break;case 2:t.points[1][0]+=e,t.points[2][0]+=e;break;case 3:t.points[2][1]+=e,t.points[3][1]+=e}return t.computeBbox()},_createPoints:function(t,e){var i=Shape.randomPoint(t,e),r=Shape.randomPoint(t,e),n=Math.min(i[0],r[0]),a=Math.max(i[0],r[0]),o=Math.min(i[1],r[1]),c=Math.max(i[1],r[1]);return[[n,o],[a,o],[a,c],[n,c]]}}),r}]),angular.module("umbraco.resources").factory("primitiveShapeFactory",["primitiveCanvasFactory",function(r){function t(){this.bbox={}}return t.prototype={mutate:function(){return this},toSVG:function(){},rasterize:function(t){var e=new r(this.bbox.width,this.bbox.height),i=e.ctx;return i.fillStyle="#000",i.globalAlpha=t,i.translate(-this.bbox.left,-this.bbox.top),this.render(i),e},render:function(){}},t.randomPoint=function(t,e){return[~~(Math.random()*t),~~(Math.random()*e)]},t.create=function(t){var e=t.shapeTypes;return new(0,e[Math.floor(Math.random()*e.length)])(t.width,t.height)},t}]),angular.module("umbraco.resources").factory("primitiveTriangleFactory",["primitivePolygonFactory",function(i){function t(t,e){i.call(this,t,e,3)}return t.prototype=Object.create(i.prototype),t}]);